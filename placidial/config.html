<!DOCTYPE html>
<html>
    <meta charset="UTF-8">
    <head>
    <title>Placidial Configuration</title>
    <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
    <script src='js/slate.min.js'></script>
    </head>

    <body>
        <div class='item-container'>
            <h1 class='title' align="center">Placidial Configuration</h1>
        </div>
        <div class='item-container'>
            <div class='button-container'>
                <input name='submitButton' type='button' class='item-button' value='SAVE'>
            </div>
        </div>
        <div class='item-container'>
            <!-- <div class='item-container-header'>Second Hand</div> -->
            <div class='item-container-content'>
                <label class="item">
                    Background Color
                    <input id="bgcol" type="text" class="item-color item-color-normal">
                </label>
            </div>
        </div>
        <div class='item-container'>
            <div class='item-container-content'>
                <label class='item'>
                    Outline
                    <input id='outline' type='checkbox' class='item-toggle'>
                </label>
            </div>
            <div class='item-container-footer'>
                Add a thin outline when drawing clock hands.
            </div>
        </div>
        <div class='item-container'>
            <!-- <div class='item-container-header'>Second Hand</div> -->
            <div class='item-container-content'>
                <label class='item'>
                    Show Day
                    <input id='showday' type='checkbox' class='item-toggle'>
                </label>
            </div>
            <div class='item-container-footer'>
                Show day of month and marker for day of week.
            </div>
        </div>
        <div class='item-container'>
            <div class="item-container-header">Hour Hand</div>
            <div class='item-container-content'>
                <label class="item">
                    Color
                    <input id="hour-col" type="text" class="item-color item-color-normal">
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Width</label>
                <label class="item">
                    <input min='1' max='15' type="range" class="item-slider" name='hour-width'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='hour-width' type="text" class="item-input" name='hour-width'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Length</label>
                <label class="item">
                    <input type="range" class="item-slider" name='hour-length'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='hour-length' type="text" class="item-input" name='hour-length'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Extend</label>
                <label class="item">
                    <input max='30' type="range" class="item-slider" name='hour-extend'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='hour-extend' type="text" class="item-input" name='hour-extend'>
                    </div>
                </label>
            </div>
        </div>
        <div class='item-container'>
            <div class="item-container-header">Minute Hand</div>
            <div class='item-container-content'>
                <label class="item">
                    Hand Color
                    <input id="min-col" type="text" class="item-color item-color-normal">
                </label>
            </div>
            <div class='item-container-content'>
                <label class="item">
                    Center Color
                    <input id="min-centercol" type="text" class="item-color item-color-normal">
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Width</label>
                <label class="item">
                    <input min='1' max='15' type="range" class="item-slider" name='min-width'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='min-width' type="text" class="item-input" name='min-width'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Length</label>
                <label class="item">
                    <input type="range" class="item-slider" name='min-length'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='min-length' type="text" class="item-input" name='min-length'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Extend</label>
                <label class="item">
                    <input max='30' type="range" class="item-slider" name='min-extend'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='min-extend' type="text" class="item-input" name='min-extend'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Center Width</label>
                <label class="item">
                    <input max='32' type="range" class="item-slider" name='min-centerwidth'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='min-centerwidth' type="text" class="item-input" name='min-centerwidth'>
                    </div>
                </label>
            </div>
        </div>
        <div class='item-container'>
            <div class="item-container-header">Second Hand</div>
            <div class='item-container-content'>
                <label class='item'>
                    Show
                    <input id='showsec' type='checkbox' class='item-toggle'>
                </label>
            </div>
            <div class='item-container-content'>
                <label class="item">
                    Hand Color
                    <input id="sec-col" type="text" class="item-color item-color-normal">
                </label>
            </div>
            <div class='item-container-content'>
                <label class="item">
                    Center Color
                    <input id="sec-centercol" type="text" class="item-color item-color-normal">
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Width</label>
                <label class="item">
                    <input min='1' max='15' type="range" class="item-slider" name='sec-width'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='sec-width' type="text" class="item-input" name='sec-width'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Length</label>
                <label class="item">
                    <input type="range" class="item-slider" name='sec-length'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='sec-length' type="text" class="item-input" name='sec-length'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Extend</label>
                <label class="item">
                    <input max='30' type="range" class="item-slider" name='sec-extend'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='sec-extend' type="text" class="item-input" name='sec-extend'>
                    </div>
                </label>
            </div>
            <div class="item-container-content">
                <label class='item'>Center Width</label>
                <label class="item">
                    <input max='32' type="range" class="item-slider" name='sec-centerwidth'>
                    <div class="item-input-wrapper item-slider-text">
                        <input id='sec-centerwidth' type="text" class="item-input" name='sec-centerwidth'>
                    </div>
                </label>
            </div>
        </div>
        <div class='item-container'>
            <div class='button-container'>
                <input name='submitButton' type='button' class='item-button' value='SAVE'>
            </div>
        </div>

    </body>
    <script>
        function colorFromString(str) {
            var col = parseInt(str);
            var col8 = ((col & 0xC00000) >> (22 - 4)) |
                       ((col & 0x00C000) >> (14 - 2)) |
                       ((col & 0x0000C0) >> 6) | 0xC0;
            return col8;
        }

        function colorToString(c) {
            var col8 = parseInt(c);
            var col = (((col8 & 0x30) * 0x55) << 12) |
                      (((col8 & 0x0C) * 0x55) << 6) |
                      ((col8 & 0x03) * 0x55);
            var str = "0x" + ("000000" + col.toString(16)).slice(-6);
            console.log(str);
            return str;
        }

        function getHand(hand) {
            var col = colorFromString(document.getElementById(hand+"-col").value);
            var width = document.getElementById(hand+"-width").value * 16;
            var length = Math.round(document.getElementById(hand+"-length").value * 255 / 100);
            var extend = Math.round(document.getElementById(hand+"-extend").value * 255 / 100);
            var packed = (col << 24) | (width << 16) | (length << 8) | extend;
            return packed;
        }

        function getCenter() {
            var col0 = colorFromString(document.getElementById("min-centercol").value);
            var col1 = colorFromString(document.getElementById("sec-centercol").value);
            var r0 = document.getElementById("min-centerwidth").value;
            var r1 = document.getElementById("sec-centerwidth").value;
            var packed = (r0 << 24) | (col0 << 16) | (r1 << 8) | col1;
            return packed;
        }

        function setSlider(name, value) {
            var elems = document.getElementsByName(name);
            for (var e of elems) {
                e.value = value;
            }
        }

        function setHand(hand, packed) {
            var col = (packed >> 24) & 0xFF;
            var width = (packed >> 16) & 0xFF;
            var length = (packed >> 8) & 0xFF;
            var extend = packed & 0xFF;
            document.getElementById(hand+"-col").value = colorToString(col);
            setSlider(hand+"-width", Math.round(width / 16));
            setSlider(hand+"-length", Math.round(length * 100 / 255));
            setSlider(hand+"-extend", Math.round(extend * 100 / 255));
        }

        function setCenter(packed) {
            var r0 = (packed >> 24) & 0xFF;
            var r1 = (packed >> 8) & 0xFF;
            var col0 = (packed >> 16) & 0xFF;
            var col1 = (packed) & 0xFF;

            setSlider("min-centerwidth", r0);
            setSlider("sec-centerwidth", r1);
            document.getElementById("min-centercol").value = colorToString(col0);
            document.getElementById("sec-centercol").value = colorToString(col1);
        }

        function getConfigData() {
            var configData = {
                'showsec' : +document.getElementById('showsec').checked,
                'showday' : +document.getElementById('showday').checked,
                'outline' : +document.getElementById('outline').checked,
                'bgcol' : colorFromString(document.getElementById('bgcol').value),
                'hour' : getHand('hour'),
                'min' : getHand('min'),
                'sec' : getHand('sec'),
                'center': getCenter(),
            };

            console.log('Got: ' + JSON.stringify(configData));
            return configData;
        }

        function getQueryParam(variable, defaultValue)
        {
            var query = location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++)
            {
                var pair = vars[i].split('=');
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return defaultValue || false;
        }

        var submitButtons = document.getElementsByName('submitButton');
        for (var b of submitButtons)
            b.addEventListener('click', function() {
                console.log('Submit');

                // Set the return URL depending on the runtime environment
                var return_to = getQueryParam('return_to', 'pebblejs://close#');
                document.location =
                    return_to + encodeURIComponent(JSON.stringify(getConfigData()));
            });

        (function() {
            document.getElementById("showsec").checked =
                parseInt(getQueryParam("showsec", 0));
            document.getElementById("showday").checked =
                parseInt(getQueryParam("showday", 1));
            document.getElementById("outline").checked =
                parseInt(getQueryParam("outline", 1));
            document.getElementById("bgcol").value =
                colorToString(getQueryParam("bgcol", 0));
            setHand("hour", parseInt(getQueryParam("hour", "0xFF80A000")));
            setHand("min", parseInt(getQueryParam("min", "0xFF80D200")));
            setHand("sec", parseInt(getQueryParam("sec", "0xF030D228")));
            setCenter(parseInt(getQueryParam("center", "0x0EFF08F0")));
        })();
</script>
</html>
